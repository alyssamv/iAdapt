---
title: "Trial simulation"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Trial simulation}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(iAdapt)
```

## Overview 

This package provides R code for simulating \{and implementing\} the adaptive two-stage early-phase dose escalation design for continuous immunologic outcomes with safety constraints. Stage 1 is safety-driven dose-escalation, and Stage 2 employs efficacy-driven randomization while continuing to monitor dose safety. This design is relevant in the face of a non-monotonous dose-toxicity relationship - a phenomenon that most often seen in immunologic therapies [REFERENCE]. Additionally, the probabilistic nature (as opposed to rule-based) provides an advantage in identifying the optimal dose to carry forward in development. 

The design uses a likelihood paradigm to determine the acceptability (safety) of a dose. e.g. In Stage 1, when the likelihood ratio for a dose is greater than a prespecified threshold, the dose is considered acceptable and subsequent patients are enrolled on the next dose level. Conversely, if the likelihood ratio is less than or equal to the threshold, escalation is stopped. Full details on the method can be found in the publication by Chiuzan et al., found [here](https://www.tandfonline.com/doi/abs/10.1080/19466315.2018.1462727).

The example we will be working with is the following: suppose we have a study with 5 dose levels to test, each of which has an associated "true" toxicity level and (mean) efficacy. Additionally, we specify an acceptable and unacceptable proportion of dose-limiting toxicities (DLTs). N patients are to be assigned to each dose level. We work with a continuous efficacy outcome and binary toxicity measure.



```{r}
# Number of pre-specified dose levels
dose <- 5 

# Vector of true toxicities associated with each dose
dose.tox <- c(0.05, 0.10, 0.15, 0.20, 0.30)       

# Acceptable (p_yes) and unacceptable (p_no) DLT rates used for establishing safety
p_no <- 0.40                                     
p_yes <- 0.15    

# Likelihood-ratio (LR) threshold
K <- 2                                          

# Cohort size used in stage 1
coh.size <- 3 

# Vector of true mean efficacies per dose (here mean percent persistence per dose)
m <- c(5, 15, 40, 65, 80)                     

# Efficacy(equal) variance per dose
v <- rep(0.01,5) 

# Total sample size (stages 1&2)                            
N <- 25                                        

# Stopping rule: if dose 1 is the only safe dose, allocate up to 9 pts.
stop.rule <- 9   
```


## Stage 1

Stage 1 establishes the safety profiles of the predefined doses. 


Function to generate and tabulate toxicities per dose level.
```{r}
tox.profile(dose = dose, dose.tox = dose.tox, p1 = p_no, p2 = p_yes, K = K, coh.size = coh.size)
```

Function to select only the acceptable toxic doses 
```{r}
safe.dose(dose = dose, dose.tox = dose.tox, p1 = p_no, p2 = p_yes, K = K, coh.size = coh.size) 
```
 
Function to generate efficacy outcomes (here percent persistence) for each dose
```{r}
eff.stg1(dose = dose, dose.tox = dose.tox, p1 = p_no, p2 = p_yes, K = K, coh.size = coh.size, m, v, nbb = 100)
```

 

## Stage 2

If 2 or more doses are considered acceptable after stage 1, the remaining patients are randomized to these open doses until the total sample size N is reached. If only dose 1 is acceptable after stage 1, allocate up to 9 patients (stop.rule=9)	
 
 
Function to fit a linear regression for the continuous efficacy outcomes, compute the randomization probabilities per dose and allocate the next subject to an acceptable safe dose that has the highest randomization probability.
```{r}
rand.stg2(dose, dose.tox, p_no, p_yes, K, coh.size, m, v, N, stop.rule = stop.rule, cohort = 1, samedose = T, nbb = 100) 
```

The complete vectors of dose allocations and efficacy outcomes can be used to compute the operating characteristics of the design in repeated simulations.
 
 
 
 
 
 