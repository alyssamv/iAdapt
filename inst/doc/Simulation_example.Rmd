---
title: "Trial simulation"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Trial simulation}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(iAdapt)
```

## Overview 

Here we provide code to simulate a single trial. See the README file and the full [publication](https://www.tandfonline.com/doi/abs/10.1080/19466315.2018.1462727) for greater overview of the design framework. 

The examples we will be working with are the following: suppose we have a study with 5 dose levels to test, each of which has an associated "true" toxicity level and (mean) efficacy. Additionally, we specify an acceptable and unacceptable proportion of dose-limiting toxicities (DLTs). N patients are to be assigned to each dose level. We work with a continuous efficacy outcome and binary toxicity measure. In scenario 1, we will work with a monoton dose-response relationship; in scenario 2, we will work with a non-monotone dose-response relationship. 

## Scenario 1: Monotone dose-response

```{r}
library(iAdapt)

# Number of pre-specified dose levels
dose <- 5 

# Vector of true toxicities associated with each dose
dose.tox <- c(0.05, 0.10, 0.15, 0.20, 0.30)       

# Acceptable (p_yes) and unacceptable (p_no) DLT rates used for establishing safety
p_no <- 0.25                                     
p_yes <- 0.15    

# Likelihood-ratio (LR) threshold
K <- 2                                          

# Cohort size used in stage 1
coh.size <- 3 

# Vector of true mean efficacies per dose (here mean percent persistence per dose)
m <- c(5, 15, 40, 65, 80)   # MUST BE THE SAME LENGTH AS dose.tox                  

# Efficacy(equal) variance per dose
v <- rep(0.01,5) 

# Total sample size (stages 1&2)                            
N <- 25                                        

# Stopping rule: if dose 1 is the only safe dose, allocate up to 9 pts.
stop.rule <- 9   
```

Note that, as we've specified them, we have monotone dose-toxicity and dose-response curves, as shown below. If we have a cutoff dose-limiting toxicity (DLT) rate of 0.25, (horizontal dotted line, figure a), then our target dose is dose 4 (green point). Using a likelihood framework, our design should, on average, choose this dose-level with high accuracy.

```{r}
par(mfrow = c(1,2))
plot(x = 1:5, y = dose.tox, ylim = c(0, 0.4),
     type = 'b',
     xlab = "Dose level", ylab = "Toxicity rate",
     main = "(a) Dose-toxicity")
lines(x = 0:6, y = rep(0.25, 7), lty = 3) # threshold toxicity value
points(x = 4, y = dose.tox[4], pch = 15, col = "green") # highlight best dose

plot(x = 1:5, y = m, ylim = c(0, 100),
     type = 'b',
     xlab = "Dose level", ylab = "Efficacy",
     main = "(b) Dose-response")
points(x = 4, y = m[4], pch = 15, col = "green") # highlight best dose
```


### Stage 1

Stage 1 establishes the safety profiles of the predefined doses. 

Function to generate and tabulate toxicities per dose level:
```{r}
set.seed(2)
tox.profile(dose = dose, dose.tox = dose.tox, p1 = p_no, p2 = p_yes, K = K, coh.size = coh.size)
```

The first and third columns give the dose assignment for all specified doses (in this case, 5). The second column gives the number of DLTs observed at that dose. The fourth column gives the likelihood ratio of acceptable toxicity (in this case, DLT rate <0.25). 

Now let's see which doses the design selects as being acceptably toxic.


Function to select only the acceptable toxic doses: 
```{r}
set.seed(2)
safe.dose(dose = dose, dose.tox = dose.tox, p1 = p_no, p2 = p_yes, K = K, coh.size = coh.size) 
```
 
We can see that the design selects only doses 1 through 4; \$alloc.safe gives the dose assignment (first column) and number of DLTs (second column). \$alloc.total gives the dose assignment for all enrolled patients (\$n1 gives total sample size, in this case 15 subjects), where we see that 3 patients were assigned to each dose as specified by `coh.size`.

As the design allows, we can also begin collecting safety information for each dose.
 
Function to generate efficacy outcomes (here percent persistence) for each dose:
```{r}
set.seed(2)
eff.stg1(dose = dose, dose.tox = dose.tox, p1 = p_no, p2 = p_yes, K = K, coh.size = coh.size, m, v, nbb = 100)
```

\$Y.safe and \$d.safe gives the efficacies and dose allocation for all subject enrolled on acceptably toxic doses; \$tox.safe gives the number of DLTs for each dose level; \$Y.alloc and \$d.alloc gives the efficacies and dose allocation for all subject enrolled on all dose levels.

### Stage 2

If 2 or more doses are considered acceptable after stage 1, the remaining patients are randomized to these open doses until the total sample size N is reached. If only dose 1 is acceptable after stage 1, allocate up to 9 patients (`stop.rule = 9`)	

Function to fit a linear regression for the continuous efficacy outcomes, compute the randomization probabilities per dose and allocate the next subject to an acceptable safe dose that has the highest randomization probability:
```{r}
set.seed(2)
rand.stg2(dose, dose.tox, p_no, p_yes, K, coh.size, m, v, N, stop.rule = stop.rule, cohort = 1, samedose = T, nbb = 100) 
```

The complete vectors of dose allocations and efficacy outcomes can be used to compute the operating characteristics of the design in repeated simulations.
 



 
## Scenario 2: Non-monotone dose-response

Here, all parameters are the same as in scenario 1, except for the observed efficacies. Instead, they take on a parabolic nature.

```{r}
# Vector of true mean efficacies per dose (here mean percent persistence per dose)
m <- c(15, 35, 80, 60, 40)   # MUST BE THE SAME LENGTH AS dose.tox                  

```

Now we have a non-monotone dose-response curves, as shown below. If we have a cutoff toxicity rate of 0.25, (horizontal dotted line, figure a) and assume a monotone dose-response relationship, then we would choose dose level 4 as we did in the previous scenario (red point). However, note that according to the true efficacies of each dose, the lesser dose number 3 is actually best (green point). Assuming a monotone relationship, we would be incorrectly pushing forward a more toxic and less effective dose level. Again using a likelihood framework, our design should, on average, choose dose level 3 with high accuracy.

```{r}
par(mfrow = c(1,2))
plot(x = 1:5, y = dose.tox, ylim = c(0, 0.4),
     type = 'b',
     xlab = "Dose level", ylab = "Toxicity rate",
     main = "(a) Dose-toxicity")
lines(x = 0:6, y = rep(0.25, 7), lty = 3) # threshold toxicity value
points(x = 3, y = dose.tox[3], pch = 15, col = "green") # highlight most effecive dose
points(x = 4, y = dose.tox[4], pch = 15, col = "red") # highlight MTD

plot(x = 1:5, y = m, ylim = c(0, 100),
     type = 'b',
     xlab = "Dose level", ylab = "Efficacy",
     main = "(b) Dose-response")
points(x = 3, y = m[3], pch = 15, col = "green") # highlight best dose
points(x = 4, y = m[4], pch = 15, col = "red") # highlight MTD

```

### Stage 1

Stage 1 establishes the safety profiles of the predefined doses. All output can be interpreted in the same way as in scenario 1. However, note that in this case we identify dose level 3 as the last acceptably toxic dose.


Function to generate and tabulate toxicities per dose level.
```{r}
set.seed(1)
tox.profile(dose = dose, dose.tox = dose.tox, p1 = p_no, p2 = p_yes, K = K, coh.size = coh.size)
```

Function to select only the acceptable toxic doses 
```{r}
set.seed(1)
safe.dose(dose = dose, dose.tox = dose.tox, p1 = p_no, p2 = p_yes, K = K, coh.size = coh.size) 
```
 
Function to generate efficacy outcomes (here percent persistence) for each dose
```{r}
set.seed(1)
eff.stg1(dose = dose, dose.tox = dose.tox, p1 = p_no, p2 = p_yes, K = K, coh.size = coh.size, m, v, nbb = 100)
```

 

### Stage 2

If 2 or more doses are considered acceptable after stage 1, the remaining patients are randomized to these open doses until the total sample size N is reached. If only dose 1 is acceptable after stage 1, allocate up to 9 patients (stop.rule=9)	

Function to fit a linear regression for the continuous efficacy outcomes, compute the randomization probabilities per dose and allocate the next subject to an acceptable safe dose that has the highest randomization probability.

```{r}
set.seed(1)
rand.stg2(dose, dose.tox, p_no, p_yes, K, coh.size, m, v, N, stop.rule = stop.rule, cohort = 1, samedose = T, nbb = 100) 
```

The complete vectors of dose allocations and efficacy outcomes can be used to compute the operating characteristics of the design in repeated simulations.
 
 
 
 
 